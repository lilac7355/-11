<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥è«‹å‡ä»£ç†äººæŸ¥æ‰¾ç³»çµ± (æœ€çµ‚ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è®“é é¢çœ‹èµ·ä¾†æ›´åƒæ‰‹æ©Ÿæ‡‰ç”¨ç¨‹å¼ */
        body {
            background-color: #f7f9fb;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px 0;
        }
        .app-container {
            width: 100%;
            max-width: 420px;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header class="p-4 border-b border-gray-100 bg-white">
        <h1 class="text-xl font-bold text-center text-indigo-800">å“¡å·¥è«‹å‡ä»£ç†äººæŸ¥æ‰¾ç³»çµ± (æœ€çµ‚ç‰ˆ)</h1>
    </header>

    <main class="p-4 space-y-6">
        <section class="bg-indigo-50 p-4 rounded-lg shadow-md">
            <h2 class="text-lg font-semibold text-indigo-900 mb-3">ä»£ç†äººæ‰‹å‹•é¸æ“‡ç³»çµ±</h2>
            <p class="text-sm text-indigo-700 mb-4">è«‹è¼¸å…¥è«‹å‡è³‡è¨Šï¼Œä¸¦å¾å€™é¸åå–®ä¸­é¸æ“‡ä»£ç†äººã€‚</p>

            <div id="result-box" class="min-h-[80px] p-3 border rounded-lg bg-yellow-50 border-yellow-300 text-gray-700 mb-4">
                <div class="font-bold text-base mb-1">ğŸ” ç³»çµ±è¨Šæ¯</div>
                <p class="text-sm">è«‹å¡«å¯«ä¸Šæ–¹æ¬„ä½å¾Œï¼Œé»æ“Šã€ŒæŸ¥æ‰¾ä»£ç†äººã€æŒ‰éˆ•ã€‚</p>
            </div>

            <div class="space-y-3">
                <div>
                    <label for="employeeId" class="block text-sm font-medium text-gray-700">è«‹å‡å“¡å·¥å§“å (ID)</label>
                    <select id="employeeId" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="" disabled selected>è«‹é¸æ“‡è«‹å‡å“¡å·¥...</option>
                    </select>
                </div>

                <div>
                    <label for="leaveType" class="block text-sm font-medium text-gray-700">å‡åˆ¥é¸æ“‡</label>
                    <select id="leaveType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="" disabled selected>è«‹é¸æ“‡å‡åˆ¥...</option>
                    </select>
                </div>

                <div class="flex space-x-2">
                    <div class="flex-1">
                        <label for="startDate" class="block text-sm font-medium text-gray-700">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="startDate" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="flex-1">
                        <label for="endDate" class="block text-sm font-medium text-gray-700">çµæŸæ—¥æœŸ</label>
                        <input type="date" id="endDate" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>

                <button type="button" id="searchButton" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                    æŸ¥æ‰¾ä»£ç†äºº
                </button>
            </div>
        </section>

        <section id="selection-area" class="bg-white p-4 rounded-lg border border-gray-200 shadow-md hidden">
            <h3 class="text-md font-semibold text-gray-800 mb-3">é¸æ“‡èˆ‡ç¢ºèªä»£ç†äºº</h3>
            
            <div class="space-y-3">
                <div>
                    <label for="substituteSelect" class="block text-sm font-medium text-gray-700">é¸æ“‡ä»£ç†äºº</label>
                    <select id="substituteSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm rounded-md">
                        <option value="" disabled selected>è«‹é¸æ“‡ä¸€ä½ä»£ç†äºº...</option>
                    </select>
                </div>

                <button type="button" id="confirmButton" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-700 transition duration-150">
                    ç¢ºèªé€å‡ºè«‹å‡ç”³è«‹
                </button>
            </div>
        </section>

        <section class="bg-gray-100 p-4 rounded-lg shadow-md">
            <h3 class="text-md font-semibold text-gray-800 mb-3 flex items-center">
                ğŸ“… ç•¶å‰ä¼‘å‡äººå“¡èˆ‡ä»£ç†äººè·è²¬
            </h3>
            <ul id="active-leaves-list" class="space-y-3">
                <li class="text-gray-500 p-2 border border-gray-200 rounded-lg">è¼‰å…¥ä¸­...</li>
            </ul>
        </section>
    </main>
</div>

<script>
// ==============================================================================
// é€™æ˜¯ä½¿ç”¨ API é€²è¡Œè³‡æ–™åŒæ­¥çš„ JavaScript ç¨‹å¼ç¢¼ (è«‹å‹¿ä¿®æ”¹ï¼Œåªéœ€æ›¿æ›)
// ==============================================================================

// --- æ ¸å¿ƒè³‡æ–™å®šç¾© (Data Definition) ---
const LEAVE_TYPES = [
    "ä¼‘å‡ (Annual Leave)",
    "ç—…å‡ (Sick Leave)",
    "äº‹å‡ (Personal Leave)",
    "å–ªå‡ (Bereavement Leave)",
    "èº«å¿ƒèª¿é©å‡ (Mental Health Leave)"
];

const SPECIAL_AGENT_A_ID = "E001"; // è¨±æ˜ç¥¥
const SPECIAL_AGENT_B_ID = "E003"; // å‘‚ä¿¡å¿ 

const employeeData = [
    {"id": "E001", "name": "è¨±æ˜ç¥¥"}, 
    {"id": "E002", "name": "ç‹å­æº"},
    {"id": "E003", "name": "å‘‚ä¿¡å¿ "},
    {"id": "E004", "name": "å³æ¬£å³°"},
    {"id": "E005", "name": "è¨±æ™¯ç¿”"},
    {"id": "E006", "name": "åŠ‰è¨“å®"},
    {"id": "E007", "name": "è¨±é‡‹æ™Ÿ"},
    {"id": "E008", "name": "è¨±å®—æ–‡"},
    {"id": "E009", "name": "åŠ‰æŸæ¦•"},
    {"id": "E010", "name": "æ¥Šç„œæ·µ"},
    {"id": "E011", "name": "è¬å‚‘å„’"},
    {"id": "E012", "name": "è˜‡ä¿Šç‘‹"},
];

let activeLeaves = []; // è³‡æ–™å°‡å¾ API è¼‰å…¥ï¼Œä¸å†ä½¿ç”¨ localStorage

// --- API æºé€šå‡½å¼ (API Communication Functions) ---

/** 1. å¾å¾Œç«¯è¼‰å…¥è«‹å‡è¨˜éŒ„ */
async function loadActiveLeaves() {
    try {
        renderResult('pending', 'è¼‰å…¥ä¸­', 'æ­£åœ¨å¾ä¸­å¤®è³‡æ–™åº«ç²å–æœ€æ–°ä¼‘å‡åå–®...');
        const response = await fetch('/api/leaves');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        activeLeaves = await response.json();
        // ç¢ºä¿æ‰€æœ‰ç‰©ä»¶éƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œä¸¦åŒ…å«å¿…è¦çš„å­—æ®µ (ä¾‹å¦‚ end)
        activeLeaves = activeLeaves.filter(leave => leave && leave.end);
        
        displayActiveLeaves();
        renderResult('info', 'è¼‰å…¥æˆåŠŸ', 'ä¼‘å‡åå–®å·²æ›´æ–°ã€‚');
    } catch (error) {
        console.error("Failed to load active leaves:", error);
        renderResult('error', 'è¼‰å…¥å¤±æ•—', 'ç„¡æ³•é€£æ¥åˆ°ä¸­å¤®è³‡æ–™åº«ã€‚è«‹ç¢ºèªå¾Œç«¯ API æ˜¯å¦å·²éƒ¨ç½²ã€‚');
    }
}

/** 2. å„²å­˜æ–°çš„è«‹å‡è¨˜éŒ„åˆ°å¾Œç«¯ */
async function saveNewLeave(newLeave) {
    try {
        const response = await fetch('/api/leaves', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newLeave)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // æˆåŠŸå¾Œé‡æ–°è¼‰å…¥ä¸¦é¡¯ç¤ºæœ€æ–°åˆ—è¡¨
        await loadActiveLeaves(); 
        return true;
    } catch (error) {
        console.error("Failed to save new leave:", error);
        renderResult('error', 'æäº¤å¤±æ•—', 'ç„¡æ³•å°‡è«‹å‡è¨˜éŒ„ä¿å­˜åˆ°è³‡æ–™åº«ã€‚');
        return false;
    }
}

/** 3. å–æ¶ˆè«‹å‡è¨˜éŒ„ */
async function cancelLeave(employeeId, startDate) {
    try {
        const response = await fetch('/api/leaves/cancel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ employeeId, startDate })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // æˆåŠŸå¾Œé‡æ–°è¼‰å…¥ä¸¦é¡¯ç¤ºæœ€æ–°åˆ—è¡¨
        await loadActiveLeaves();
        renderResult('success', 'è«‹å‡å·²å–æ¶ˆ', `å“¡å·¥ ${getEmployeeNameById(employeeId)} (${employeeId}) çš„è«‹å‡è¨˜éŒ„å·²æˆåŠŸå–æ¶ˆã€‚`);
        return true;
    } catch (error) {
        console.error("Failed to cancel leave:", error);
        renderResult('error', 'å–æ¶ˆå¤±æ•—', 'ç„¡æ³•åˆªé™¤è³‡æ–™åº«ä¸­çš„è«‹å‡è¨˜éŒ„ã€‚');
        return false;
    }
}


// --- æ ¸å¿ƒé‚è¼¯å‡½æ•¸ (Core Logic Functions) ---

/** æª¢æŸ¥æ½›åœ¨ä»£ç†äººæ˜¯å¦åœ¨è«‹æ±‚çš„æ—¥æœŸç¯„åœå…§å·²å®‰æ’ä¼‘å‡ */
function isAvailable(employeeId, startDateStr, endDateStr) {
    const reqStart = Date.parse(startDateStr);
    const reqEnd = Date.parse(endDateStr);

    if (isNaN(reqStart) || isNaN(reqEnd) || reqStart > reqEnd) {
        return true; 
    }

    // ä½¿ç”¨å…¨åŸŸ activeLeaves (å·²å¾ API è¼‰å…¥)
    for (const leave of activeLeaves) {
        if (leave.id === employeeId) {
            // ç”±æ–¼ MongoDB å¯èƒ½å­˜å„² ObjectIdï¼Œé€™è£¡åªæ¯”è¼ƒæ—¥æœŸå­—æ®µ
            const leaveStart = Date.parse(leave.start);
            const leaveEnd = Date.parse(leave.end);

            // æª¢æŸ¥æ—¥æœŸç¯„åœæ˜¯å¦æœ‰é‡ç–Š (å¦‚æœè«‹æ±‚çš„é–‹å§‹ <= æ—¢æœ‰è«‹å‡çš„çµæŸ ä¸” è«‹æ±‚çš„çµæŸ >= æ—¢æœ‰è«‹å‡çš„é–‹å§‹)
            if (reqStart <= leaveEnd && reqEnd >= leaveStart) {
                return false; 
            }
        }
    }
    return true; 
}

/** å°‹æ‰¾ä¸¦è¿”å›æ‰€æœ‰å¯ç”¨çš„ä»£ç†äººåå–® (æŒ‰å„ªå…ˆç´šæ’åº)ã€‚ */
function getAvailableCandidates(employeeIdToFind, data, startDate, endDate) {
    const leavingEmployee = data.find(emp => emp.id === employeeIdToFind);
    const header = `${leavingEmployee.name} (${leavingEmployee.id}) è«‹å‡ (${startDate} è‡³ ${endDate})`;
    const candidates = [];

    // 1. è™•ç†ç‰¹æ®Šä»£ç†è¦å‰‡ (äº’ç‚ºæŒ‡å®šä»£ç†)
    if (employeeIdToFind === SPECIAL_AGENT_A_ID) { 
        if (isAvailable(SPECIAL_AGENT_B_ID, startDate, endDate)) {
            const substitute = data.find(emp => emp.id === SPECIAL_AGENT_B_ID);
            substitute.type = 'æŒ‡å®šä»£ç†äºº';
            candidates.push(substitute);
            return { header, candidates }; 
        } else {
            return { header, candidates: null, error: "éŒ¯èª¤ï¼šè¨±æ˜ç¥¥çš„æŒ‡å®šä»£ç†äººå‘‚ä¿¡å¿ åœ¨è©²æ—¥æœŸç¯„åœå…§æ­£åœ¨ä¼‘å‡ã€‚" };
        }
    } else if (employeeIdToFind === SPECIAL_AGENT_B_ID) { 
        if (isAvailable(SPECIAL_AGENT_A_ID, startDate, endDate)) {
            const substitute = data.find(emp => emp.id === SPECIAL_AGENT_A_ID);
            substitute.type = 'æŒ‡å®šä»£ç†äºº';
            candidates.push(substitute);
            return { header, candidates }; 
        } else {
            return { header, candidates: null, error: "éŒ¯èª¤ï¼šå‘‚ä¿¡å¿ çš„æŒ‡å®šä»£ç†äººè¨±æ˜ç¥¥åœ¨è©²æ—¥æœŸç¯„åœå…§æ­£åœ¨ä¼‘å‡ã€‚" };
        }
    }

    // 2. è™•ç†å…¶ä»–å“¡å·¥çš„ä»£ç†è¦å‰‡ (ç‰¹æ¬Šå„ªå…ˆ)
    for (const specialId of [SPECIAL_AGENT_A_ID, SPECIAL_AGENT_B_ID]) {
        if (isAvailable(specialId, startDate, endDate)) {
            const specialAgent = data.find(emp => emp.id === specialId);
            candidates.push({...specialAgent, type: 'ç‰¹æ¬Šä»£ç†äºº (é«˜éš)'});  
        }
    }
    
    // 3. å°‹æ‰¾æ‰€æœ‰å…¶ä»–å¯ç”¨çš„æ™®é€šå“¡å·¥
    data.forEach(emp => {
        const isSelf = emp.id === employeeIdToFind;
        const isSpecialAgent = emp.id === SPECIAL_AGENT_A_ID || emp.id === SPECIAL_AGENT_B_ID;
        
        if (!isSelf && !isSpecialAgent && isAvailable(emp.id, startDate, endDate)) {
            if (!candidates.some(c => c.id === emp.id)) { 
                candidates.push({...emp, type: 'ä¸€èˆ¬å€™è£œå“¡å·¥'});
            }
        }
    });

    if (candidates.length === 0) {
         return { header, candidates: null, error: "æ‰¾ä¸åˆ°ä»»ä½•å¯ç”¨çš„ä»£ç†äºº (æ‰€æœ‰å“¡å·¥åœ¨è©²æ—¥æœŸéƒ½å·²ä¼‘å‡)ã€‚" };
    }

    return { header, candidates };
}


// --- UI è™•ç†é‚è¼¯ (UI Logic) ---
const employeeSelect = document.getElementById('employeeId');
const leaveSelect = document.getElementById('leaveType');
const startDateInput = document.getElementById('startDate');
const endDateInput = document.getElementById('endDate');
const searchButton = document.getElementById('searchButton');
const confirmButton = document.getElementById('confirmButton');
const resultBox = document.getElementById('result-box');
const selectionArea = document.getElementById('selection-area');
const substituteSelect = document.getElementById('substituteSelect');
const activeLeavesList = document.getElementById('active-leaves-list'); 

let currentQueryInfo = {};

function getEmployeeNameById(id) {
    const employee = employeeData.find(emp => emp.id === id);
    return employee ? employee.name : id;
}

// å¡«å……ä¸‹æ‹‰é¸å–®
function populateSelectors() {
    employeeData.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.id;
        option.textContent = `${emp.name} (${emp.id})`; 
        employeeSelect.appendChild(option);
    });

    LEAVE_TYPES.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        leaveSelect.appendChild(option);
    });
}

// é¡¯ç¤ºç•¶å‰ä¼‘å‡äººå“¡èˆ‡ä»£ç†äººåˆ—è¡¨
function displayActiveLeaves() {
    const today = new Date();
    today.setHours(0, 0, 0, 0); 

    const filteredLeaves = activeLeaves.filter(leave => {
        // è§£ææ—¥æœŸä¸¦ä½¿ç”¨ UTC é€²è¡Œæ¯”è¼ƒ
        const [year, month, day] = leave.end.split('-').map(Number);
        const leaveEndDate = new Date(Date.UTC(year, month - 1, day)); 
        const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));

        // åªé¡¯ç¤ºçµæŸæ—¥æœŸåœ¨ä»Šå¤©æˆ–ä»Šå¤©ä¹‹å¾Œçš„è«‹å‡è¨˜éŒ„ (å³ç•¶å‰æˆ–æœªä¾†çš„ä¼‘å‡)
        return leaveEndDate.getTime() >= todayUTC.getTime();
    }).sort((a, b) => Date.parse(a.start) - Date.parse(b.start)); // æŒ‰é–‹å§‹æ—¥æœŸæ’åº


    if (filteredLeaves.length === 0) {
        activeLeavesList.innerHTML = '<li class="text-gray-500 p-2 border border-gray-200 rounded-lg">ç›®å‰æ²’æœ‰å“¡å·¥åœ¨ä¼‘å‡ä¸­ã€‚</li>';
        return;
    }

    const listItems = filteredLeaves.map(leave => { 
        const name = getEmployeeNameById(leave.id);
        const proxyName = getEmployeeNameById(leave.proxyId); 

        // å–æ¶ˆæŒ‰éˆ•éœ€è¦å“¡å·¥IDå’Œé–‹å§‹æ—¥æœŸä¾†ç™¼é€çµ¦å¾Œç«¯
        const employeeId = leave.id;
        const startDate = leave.start;

        return `<li class="p-3 bg-white rounded-lg border border-gray-200 shadow-sm flex justify-between items-start">
                    <div>
                        <div class="font-bold text-indigo-700">${name} (${leave.id}) <span class="text-xs text-red-500 font-normal">è«‹å‡ä¸­</span></div>
                        <div class="mt-1 ml-2 text-xs text-gray-600">
                            æœŸé–“ï¼š<span class="text-red-600 font-medium">${leave.start}</span> ~ <span class="text-red-600 font-medium">${leave.end}</span>
                        </div>
                        <div class="mt-1 ml-2 text-xs text-gray-600">
                            ä»£ç†äººï¼š<span class="text-green-600 font-medium">${proxyName} (${leave.proxyId})</span>
                        </div>
                    </div>
                    <button type="button" 
                            class="cancel-leave-btn bg-red-500 hover:bg-red-600 text-white text-xs font-semibold py-1 px-2 rounded-lg transition duration-150 whitespace-nowrap"
                            data-employee-id="${employeeId}"
                            data-start-date="${startDate}">
                        å–æ¶ˆè«‹å‡
                    </button>
                </li>`;
    }).join('');

    activeLeavesList.innerHTML = listItems;
}

// æ¸²æŸ“çµæœåˆ°UI
function renderResult(status, header, message) {
    let bgColor = 'bg-yellow-50';
    let borderColor = 'border-yellow-300';
    let textColor = 'text-gray-700';
    let icon = 'ğŸ”';

    if (status === 'success') {
        bgColor = 'bg-green-50';
        borderColor = 'border-green-300';
        textColor = 'text-green-800';
        icon = 'âœ…';
    } else if (status === 'fail' || status === 'error') {
        bgColor = 'bg-red-50';
        borderColor = 'border-red-300';
        textColor = 'text-red-800';
        icon = 'âŒ';
    } else if (status === 'pending') {
        bgColor = 'bg-blue-50';
        borderColor = 'border-blue-300';
        textColor = 'text-blue-800';
        icon = 'ğŸ“';
    } else if (status === 'info') {
        bgColor = 'bg-gray-100';
        borderColor = 'border-gray-300';
        textColor = 'text-gray-700';
        icon = 'â„¹ï¸';
    }


    let formattedMessage = message.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

    let html = `<div class="font-bold text-base mb-1 ${textColor}">${icon} ${header || 'ç³»çµ±è¨Šæ¯'}</div>`;
    html += `<p class="text-sm">${formattedMessage}</p>`;
    
    resultBox.className = `min-h-[80px] p-3 border rounded-lg ${bgColor} ${borderColor} ${textColor}`;
    resultBox.innerHTML = html;
}

// --- éšæ®µ 1: æŸ¥æ‰¾å€™é¸äºº ---
searchButton.addEventListener('click', () => {
    const employeeId = employeeSelect.value;
    const leaveType = leaveSelect.value;
    const startDate = startDateInput.value;
    const endDate = endDateInput.value;

    selectionArea.classList.add('hidden');

    if (!employeeId || !leaveType || !startDate || !endDate) {
        renderResult('error', 'è¼¸å…¥éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ã€‚');
        return;
    }

    if (Date.parse(startDate) > Date.parse(endDate)) {
        renderResult('error', 'æ—¥æœŸç„¡æ•ˆ', 'é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸã€‚');
        return;
    }

    // æŸ¥æ‰¾å€™é¸äººæ™‚ä½¿ç”¨ API è¼‰å…¥çš„ activeLeaves
    const result = getAvailableCandidates(employeeId, employeeData, startDate, endDate);
    
    currentQueryInfo = { employeeId, leaveType, startDate, endDate, header: result.header };

    if (result.error) {
        renderResult('fail', result.header, result.error);
        return;
    }
    
    substituteSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡ä¸€ä½ä»£ç†äºº...</option>';
    
    result.candidates.forEach(candidate => {
        const option = document.createElement('option');
        option.value = candidate.id;
        option.textContent = `${candidate.name} (${candidate.id}) - ${candidate.type}`;
        substituteSelect.appendChild(option);
    });

    selectionArea.classList.remove('hidden');
    renderResult('pending', result.header, `âœ… æˆåŠŸæ‰¾åˆ° ${result.candidates.length} ä½å¯ç”¨ä»£ç†äººã€‚è«‹å¾ä¸‹æ–¹çš„é¸å–®ä¸­é¸æ“‡ä¸€ä½ã€‚`);
});

// --- éšæ®µ 2: ç¢ºèªæœ€çµ‚é¸æ“‡ä¸¦æäº¤ API ---
confirmButton.addEventListener('click', async () => {
    const selectedAgentId = substituteSelect.value;

    if (!selectedAgentId) {
        renderResult('error', currentQueryInfo.header, 'è«‹å…ˆå¾ä¸‹æ‹‰å¼é¸å–®ä¸­é¸æ“‡ä¸€ä½ä»£ç†äººï¼');
        return;
    }

    const selectedAgent = employeeData.find(emp => emp.id === selectedAgentId);
    const originalEmployee = employeeData.find(emp => emp.id === currentQueryInfo.employeeId);
    
    // çµ„è£è«‹å‡è¨˜éŒ„
    const newLeave = {
        id: currentQueryInfo.employeeId,
        start: currentQueryInfo.startDate,
        end: currentQueryInfo.endDate,
        proxyId: selectedAgentId,
        type: currentQueryInfo.leaveType
    };

    // æäº¤åˆ°å¾Œç«¯ API
    const success = await saveNewLeave(newLeave);

    if (success) {
        const isSpecialAssignment = 
            (currentQueryInfo.employeeId === SPECIAL_AGENT_A_ID && selectedAgentId === SPECIAL_AGENT_B_ID) ||
            (currentQueryInfo.employeeId === SPECIAL_AGENT_B_ID && selectedAgentId === SPECIAL_AGENT_A_ID);
        
        let message = '';
        if (isSpecialAssignment) {
             message = `**è·å‹™ä»£ç†äººï¼š** ${selectedAgent.name} ï¼ˆID: ${selectedAgent.id}ï¼‰ **å·²æ ¹æ“šç‰¹æ®Šè¦å‰‡æŒ‡å®šã€‚**`;
        } else if (selectedAgentId === SPECIAL_AGENT_A_ID || selectedAgentId === SPECIAL_AGENT_B_ID) {
             message = `**è·å‹™ä»£ç†äººï¼š** ${selectedAgent.name} ï¼ˆID: ${selectedAgent.id}ï¼‰ **å·²æŒ‡å®šç‚ºç‰¹æ¬Šä»£ç†äººã€‚**`;
        } else {
             message = `**è·å‹™ä»£ç†äººï¼š** ${selectedAgent.name} ï¼ˆID: ${selectedAgent.id}ï¼‰ **å·²æŒ‡å®šç‚ºå€™è£œä»£ç†äººã€‚**`;
        }
        
        renderResult('success', 
            `${originalEmployee.name} (${originalEmployee.id}) è«‹ã€${currentQueryInfo.leaveType}ã€‘ç¢ºèªçµæœ`,
            message + `<br>è«‹å‡å€é–“ï¼š${currentQueryInfo.startDate} è‡³ ${currentQueryInfo.endDate}`
        );
        selectionArea.classList.add('hidden');
    }
});

// --- å–æ¶ˆè«‹å‡æŒ‰éˆ•çš„äº‹ä»¶å§”æ´¾ ---
activeLeavesList.addEventListener('click', (event) => {
    const button = event.target.closest('.cancel-leave-btn');
    if (button) {
        const employeeId = button.dataset.employeeId;
        const startDate = button.dataset.startDate;
        if (employeeId && startDate && confirm("ç¢ºå®šè¦å–æ¶ˆé€™ç­†è«‹å‡è¨˜éŒ„å—ï¼Ÿ")) {
            cancelLeave(employeeId, startDate);
        }
    }
});

// åˆå§‹åŒ–ï¼šå¡«å……é¸å–®ä¸¦å¾ API è¼‰å…¥ç•¶å‰ä¼‘å‡åˆ—è¡¨
populateSelectors();
loadActiveLeaves(); // ç³»çµ±å•Ÿå‹•æ™‚å°±é–‹å§‹è¼‰å…¥è³‡æ–™
</script>

</body>
</html>